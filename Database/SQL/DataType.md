## SQL

SQL是结构化查询语言Structured Query Language的缩写.

### 主流关系数据库

>目前，主流的关系数据库主要分为以下几类：

1. 商用数据库，例如：Oracle，SQL Server，DB2等；
2. 开源数据库，例如：MySQL，PostgreSQL等；
3. 桌面数据库，以微软Access为代表，适合桌面应用程序使用；
4. 嵌入式数据库，以Sqlite为代表，适合手机应用和桌面程序。

### 最常用的数据类型

名称          类型                  说明
INT           整型             4字节整数类型，范围约+/-21亿
BIGINT        长整型           8字节整数类型，范围约+/-922亿亿
REAL          浮点型           4字节浮点数，范围约+/-1038
DOUBLE        浮点型           8字节浮点数，范围约+/-10308
DECIMAL(M,N)  高精度小数       由用户指定精度的小数，例如，DECIMAL(20,10)表示一共20位，其中小数10位，通常用于财务计算
CHAR(N)      定长字符串        存储指定长度的字符串，例如，CHAR(100)总是存储100个字符的字符串
VARCHAR(N)   变长字符串      存储可变长度的字符串，例如，VARCHAR(100)可以存储0~100个字符的字符串
BOOLEAN      布尔类型         存储True或者False
DATE         日期类型         存储日期，例如，2018-06-22
TIME         时间类型         存储时间，例如，12:20:59
DATETIME     日期和时间类型    存储日期+时间，例如，2018-06-22 12:20:59

> 上面的表中列举了最常用的数据类型。很多数据类型还有别名:

* REAL == FLOAT(24)

> 不常用的数据类型举例:

* TINYINT(范围在0~255）
 
> 数据库厂商还会支持特定的数据类型,例如：

* JSON

选择数据类型的时候，要根据业务规则选择合适的类型,通常来说(以下两种类型是使用最广泛的):

1. BIGINT能满足整数存储的需求
2. VARCHAR(N)能满足字符串存储的需求

> 现实情况是，如果我们只使用`标准SQL的核心功能`，那么所有数据库通常都可以执行。不常用的SQL功能，不同的数据库支持的程度都不一样。而各个数据库支持的各自扩展的功能，通常我们把它们称之为“方言”。

#### SQL语言几种操作数据库的能力：

1. DDL：Data Definition Language(创建表、删除表、修改表结构-由数据库管理员执行)
2. DML：Data Manipulation Language(添加、删除、更新数据的能力-应用程序对数据库的日常操作)
3. DQL：Data Query Language(查询数据-最频繁的数据库日常操作)

### 语法特点

SQL语言`关键字`不区分大小写！！！但是，针对不同的数据库，对于`表名`和`列名`，有的数据库区分大小写，有的数据库不区分大小写。同一个数据库，有的在Linux上区分大小写，有的在Windows上不区分大小写, 所以，本教程约定：`SQL关键字`总是大写，以示突出，`表名`和`列名`均使用`小写`。

## 关系模型

表的每一行称为记录(Record）.表的每一列称为字段(Column）

>字段定义了数据类型(整型、浮点型、字符串、日期等），以及是否允许为NULL。注意NULL表示字段数据不存在。一个整型字段如果为NULL不表示它的值为0，同样的，一个字符串型字段为NULL也不表示它的值为空串''

> 通常情况下，字段应该避免允许为NULL。不允许为NULL可以简化查询条件，加快查询速度，也利于应用程序读取数据后无需判断是否为NULL。

### 主键

主键指能够通过某个字段唯一区分出不同的记录，这个字段被称为主键。
对主键的要求，最关键的一点是：记录一旦插入到表中，主键最好不要再修改，因为主键是用来唯一定位记录的，修改了主键，会造成一系列的影响.

由于主键的作用十分重要，如何选取主键会对业务开发产生重要影响。如果我们以学生的身份证号作为主键，似乎能唯一定位记录。然而，身份证号也是一种业务场景，如果身份证号升位了，或者需要变更，作为主键，不得不修改的时候，就会对业务产生严重影响。

>所以，选取主键的一个基本原则是：不使用任何业务相关的字段作为主键,主键也不应该允许NULL.

因此，身份证号、手机号、邮箱地址这些看上去可以唯一的字段，均不可用作主键。

作为主键最好是完全业务无关的字段，我们一般把这个字段命名为id。常见的可作为id字段的类型有：

1. 自增整数类型(自增INT，自增BIGINT等)：数据库会在插入数据时自动为每一条记录分配一个自增整数，这样我们就完全不用担心主键重复，也不用自己预先生成主键；
2. 全局唯一GUID类型：使用一种全局唯一的字符串作为主键，类似8f55d96b-8acc-4636-8cb8-76bf8abc2f57。GUID算法通过网卡MAC地址、时间戳和随机数保证任意计算机在任意时间生成的字符串都是不同的，大部分编程语言都内置了GUID算法，可以自己预算出主键。

对于大部分应用来说，通常自增类型的主键就能满足需求。我们在students表中定义的主键也是BIGINT NOT NULL AUTO_INCREMENT类型。

> 如果使用`INT自增类型`，那么当一张表的记录数超过2147483647(约21亿）时，会达到上限而出错。使用`BIGINT自增类型`则可以最多约922亿亿条记录。

#### 联合主键

对于联合主键，即两个或更多的字段都设置为主键，允许一列有重复，只要不是所有主键列都重复即可：

可以使用多个列作为联合主键，但联合主键并不常用。

### 外键

这两个表的关系可以称为“一对多”，即一个classes的记录可以对应多个students表的记录.我们需要在students表中加入一列class_id，让它的值与classes表的某条记录相对应.
在students表中，通过class_id的字段，可以把数据与另一张表关联起来，这种列称为外键。

> 外键并不是通过列名实现的，而是通过定义外键约束实现的：

```sql
ALTER TABLE students
ADD CONSTRAINT fk_class_id
FOREIGN KEY (class_id)
REFERENCES classes (id);
```

其中，外键约束的名称fk_class_id可以任意，FOREIGN KEY (class_id)指定了class_id作为外键，REFERENCES classes (id)指定了这个外键将关联到classes表的id列(即classes表的主键）。

通过定义外键约束，关系数据库可以保证无法插入无效的数据。即如果classes表不存在id=99的记录，students表就无法插入class_id=99的记录。

由于外键约束会降低数据库的性能，大部分互联网应用程序为了追求速度，并不设置外键约束，而是仅靠应用程序自身来保证逻辑的正确性。这种情况下，class_id仅仅是一个普通的列，只是它起到了外键的作用而已。

要删除一个外键约束，也是通过ALTER TABLE实现的：

```sql
ALTER TABLE students
DROP FOREIGN KEY fk_class_id;
```

注意：删除外键约束并没有删除外键这一列。删除列是通过DROP COLUMN ...实现的。

#### 多对多

一个老师可以对应多个班级，一个班级也可以对应多个老师

多对多关系实际上是通过两个一对多关系实现的，即通过一个中间表，关联两个一对多关系.

teachers表,classes表,中间表teacher_class关联两个一对多关系.

1. 通过中间表teacher_class可知teachers到classes的关系：
2. 同理可知classes到teachers的关系：

#### 一对一

有细心的童鞋会问，既然是一对一关系，那为啥不给students表增加一个mobile列，这样就能合二为一了？

如果业务允许，完全可以把两个表合为一个表。但是，有些时候，如果某个学生没有手机号，那么，contacts表就不存在对应的记录。实际上，一对一关系准确地说，是contacts表一对一对应students表。

> 还有一些应用会把一个大表拆成两个一对一的表，目的是把经常读取和不经常读取的字段分开，以获得更高的性能。例如，把一个大的用户表分拆为用户基本信息表user_info和用户详细信息表user_profiles，大部分时候，只需要查询user_info表，并不需要查询user_profiles表，这样就提高了查询速度。

> 关系数据库通过外键可以实现一对多、多对多和一对一的关系。外键既可以通过数据库来约束，也可以不设置约束，仅依靠应用程序的逻辑来保证。

### 索引

在关系数据库中，如果有上万甚至上亿条记录，在查找记录的时候，想要获得非常快的速度，就需要使用索引。

索引是关系数据库中对某一列或多个列的值进行预排序的数据结构。通过使用索引，可以让数据库系统不必扫描整个表，而是直接定位到符合条件的记录，这样就大大加快了查询速度。

> 如果要经常根据score列进行查询，就可以对score列创建索引：

```sql
ALTER TABLE students
ADD INDEX idx_score (score);
```

使用ADD INDEX idx_score (score)就创建了一个名称为idx_score，使用列score的索引。索引名称是任意的，索引如果有多列，可以在括号里依次写上，例如：

```sql
ALTER TABLE students
ADD INDEX idx_name_score (name, score);
```

`索引的效率`取决于索引列的值是否散列，即该列的值如果越互不相同，那么索引效率越高。反过来，如果记录的列存在大量相同的值，例如gender列，大约一半的记录值是M，另一半是F，因此，对该列创建索引就没有意义。

可以对一张表创建多个索引。`索引的优点是提高了查询效率`，`缺点是在插入、更新和删除记录时，需要同时修改索引`，因此，索引越多，插入、更新和删除记录的速度就越慢。

> 对于主键，关系数据库会自动对其创建主键索引。使用主键索引的效率是最高的，因为主键会保证绝对唯一。

#### 唯一索引

在设计关系数据表的时候，看上去唯一的列，例如身份证号、邮箱地址等，因为他们具有业务含义，因此不宜作为主键。但是，这些列根据业务要求，又具有唯一性约束：即不能出现两条记录存储了同一个身份证号。这个时候，就可以给该列添加一个唯一索引。例如，我们假设students表的name不能重复：

```sql
ALTER TABLE students
ADD UNIQUE INDEX uni_name (name);
```

> 通过UNIQUE关键字我们就添加了一个唯一索引。

也可以只对某一列添加一个唯一约束而不创建唯一索引：

```
ALTER TABLE students
ADD CONSTRAINT uni_name UNIQUE (name);
```

> 这种情况下，name列没有索引，但仍然具有唯一性保证。

`无论是否创建索引`，对于用户和应用程序来说，使用关系数据库不会有任何区别。这里的意思是说，当我们在数据库中查询时，如果有相应的索引可用，数据库系统就会自动使用索引来提高查询效率，如果没有索引，查询也能正常执行，只是速度会变慢。因此，索引可以在使用数据库的过程中逐步优化。


1. 通过对数据库表创建索引，可以提高查询速度。
2. 通过创建唯一索引，可以保证某一列的值具有唯一性。
3. 数据库索引对于用户和应用程序来说都是透明的。
4. 通过添加唯一约束，也能保证某一列的唯一性.